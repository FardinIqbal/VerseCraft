<!--
  app/views/poems/show.html.erb

  This template displays a single poem with its metadata, associated actions,
  and comments section.

  Features:
  - Responsive poem display
  - Like/Unlike functionality for authenticated users
  - Edit/Delete options for poem authors
  - Proper poetry formatting with line breaks
  - Attribution for public domain works
  - Interactive comments section
-->

<%# Main poem display section %>
<article class="poem">
  <%# Poem title section %>
  <h2 class="poem-title">
    <%= @poem.title %>
    <% if @poem.featured? %>
      <span class="featured-badge" title="Featured poem">â˜…</span>
    <% end %>
  </h2>

  <%# Poem metadata section %>
  <div class="poem-meta">
    <%# Handle attribution differently for historical/public domain poems %>
    <% if @poem.public_domain? %>
      By <%= @poem.user.email %>
      <% if @poem.published_year.present? %>
        | Originally published: <%= @poem.published_year %>
      <% end %>
    <% else %>
      By <%= @poem.user.email %> |
      <%= @poem.created_at.strftime("%B %d, %Y") %>
    <% end %>
    | <%= pluralize(@poem.likes.count, 'like') %>
  </div>

  <%# Main poem content with proper formatting %>
  <div class="poem-content">
    <%# simple_format maintains line breaks and spacing in poetry %>
    <%= simple_format(@poem.content, {}, wrapper_tag: "div") %>
  </div>

  <%# Attribution section for public domain works %>
  <% if @poem.public_domain? && @poem.attribution_text.present? %>
    <div class="poem-attribution">
      <%= simple_format(@poem.attribution_text) %>
    </div>
  <% end %>
</article>

<%# Action buttons section %>
<div class="poem-actions mt-1">
  <%# Like/Unlike functionality for authenticated users %>
  <% if user_signed_in? %>
    <div class="like-actions">
      <% if @poem.liked_by?(current_user) %>
        <%= button_to poem_like_path(@poem),
                      method: :delete,
                      class: 'btn btn-like active',
                      title: 'Unlike this poem' do %>
          Unlike
          <span class="likes-count"><%= @poem.likes.count %></span>
        <% end %>
      <% else %>
        <%= button_to poem_likes_path(@poem),
                      class: 'btn btn-like',
                      title: 'Like this poem' do %>
          Like
          <span class="likes-count"><%= @poem.likes.count %></span>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <%# Edit/Delete actions for poem authors or admins %>
  <div class="author-actions">
    <% if user_signed_in? && (current_user == @poem.user || current_user.admin?) %>
      <%= link_to edit_poem_path(@poem),
                  class: 'btn btn-edit',
                  title: 'Edit this poem' do %>
        Edit
      <% end %>

      <%= link_to poem_path(@poem),
                  method: :delete,
                  data: {
                    confirm: 'Are you sure you want to delete this poem? This action cannot be undone.',
                    turbo_method: :delete
                  },
                  class: 'btn btn-delete',
                  title: 'Delete this poem' do %>
        Delete
      <% end %>
    <% end %>
  </div>

  <%# Navigation back to poems index %>
  <div class="navigation-actions">
    <%= link_to poems_path,
                class: 'btn btn-back',
                title: 'Return to poems list' do %>
      Back to Poems
    <% end %>
  </div>
</div>

<%# Comments section %>
<section class="comments-section" aria-label="Poem comments">
  <%# Comments header %>
  <h3 class="comments-title">Thoughts on this poem</h3>

  <%# Comments stream - updates dynamically with Turbo %>
  <%= turbo_frame_tag "poem-comments" do %>
    <% if @poem.comments.any? %>
      <%= render @poem.comments.chronological %>
    <% else %>
      <p class="no-comments">Be the first to share your thoughts on this poem.</p>
    <% end %>
  <% end %>

  <%# Comment form for authenticated users %>
  <% if user_signed_in? %>
    <%= render "comments/form", poem: @poem %>
  <% else %>
    <p class="sign-in-prompt">
      <%= link_to "Sign in", new_user_session_path %> to share your thoughts on this poem.
    </p>
  <% end %>
</section>

<%# Optional sharing section %>
<% if Rails.env.production? %>
  <div class="sharing-options mt-3">
    <%# Add social sharing buttons here if needed %>
  </div>
<% end %>

<%# Related poems section %>
<% if @poem.user.poems.count > 1 %>
  <section class="related-poems mt-3">
    <h3>More poems by <%= @poem.user.email %></h3>
    <div class="poems-grid">
      <% @poem.user.poems.where.not(id: @poem.id).limit(3).each do |related_poem| %>
        <%= render partial: 'poems/poem_preview', locals: { poem: related_poem } %>
      <% end %>
    </div>
  </section>
<% end %>